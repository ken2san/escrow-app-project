<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>マーケット ワークフロー デモ（リッチUI）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
    .sidebar-link.active {
      background-color: #4f46e5;
      color: white;
    }
    .view-toggle-btn.active {
      background-color: #4f46e5;
      color: white;
    }
  </style>
</head>
<body class="bg-slate-100 text-slate-800">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-20 lg:w-64 bg-gray-800 text-white flex-col transition-all duration-300 hidden sm:flex">
      <div class="flex items-center justify-center lg:justify-start h-16 border-b border-gray-700 px-4">
        <svg class="w-8 h-8 text-indigo-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h18v18H3zM8 8v8m4-8v8m4-8v8"/></svg>
        <h1 class="text-2xl font-bold text-white hidden lg:block ml-2">Waritsu</h1>
      </div>
      <nav class="flex-1 mt-6 space-y-2 px-2 lg:px-4">
        <a href="#" class="sidebar-link flex items-center p-3 text-gray-300 hover:bg-gray-700 rounded-lg active">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="m12 9 3 3-3 3"/></svg>
          <span class="ml-4 font-semibold hidden lg:inline">マーケット</span>
        </a>
        <a href="#" class="sidebar-link flex items-center p-3 text-gray-300 hover:bg-gray-700 rounded-lg">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 3v18"/><path d="m15 9-3 3 3 3"/></svg>
          <span class="ml-4 font-semibold hidden lg:inline">タスク管理</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col">
      <div id="market-view">
        <header class="bg-white/80 backdrop-blur-sm z-10 border-b border-slate-200">
          <div class="flex items-center justify-between h-16 px-4 md:px-8">
            <h2 class="text-2xl font-bold text-slate-800">マーケット</h2>
          </div>
        </header>
        <div class="flex-1 overflow-y-auto p-4 md:p-8">
          <!-- AI Prompt Section -->
          <div class="mb-8">
            <div class="relative">
              <input type="text" placeholder="「@Sato Designにロゴ作成を依頼」のように、AIに話しかけてみてください..." class="w-full pl-12 pr-4 py-4 text-lg border-2 border-slate-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition">
              <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-6 h-6 text-slate-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l.34 2.27.28 1.84a2 2 0 0 0 1.95 1.54l1.84.28 2.27.34-1.64 1.64-.8.8a2 2 0 0 0 0 2.82l.8.8 1.64 1.64-2.27.34-1.84.28a2 2 0 0 0-1.95 1.54l-.28 1.84-.34 2.27-1.64-1.64-.8-.8a2 2 0 0 0-2.82 0l-.8.8-1.64 1.64.34-2.27.28-1.84a2 2 0 0 0-1.95-1.54l-1.84-.28-2.27-.34 1.64-1.64.8-.8a2 2 0 0 0 0-2.82l-.8-.8L2.69 12l2.27-.34 1.84-.28a2 2 0 0 0 1.95-1.54l.28-1.84.34-2.27L12 2.69z"/></svg>
            </div>
          </div>
          <!-- View Containers -->
          <div id="dashboard2-iframe-container" class="hidden mb-8">
            <iframe id="dashboard2-iframe" src="dashboard2-demo.html" style="width:100%;height:80vh;border:1px solid #ddd;border-radius:12px;background:#fff;"></iframe>
          </div>
          <div id="timeline-view-container">
            <div class="mb-10">
              <h3 class="text-lg font-semibold text-gray-600 mb-3 flex items-center">
                <svg class="w-5 h-5 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.042 21.672L13.684 16.6m0 0l-2.5-2.5m2.5 2.5l2.5 2.5M13.684 16.6l-5.23-1.622a2 2 0 01-1.39-2.528l1.54-4.28a2 2 0 012.528-1.39l5.23 1.622a2 2 0 011.39 2.528l-1.54 4.28a2 2 0 01-2.528 1.39z"/></svg>
                発見のヒント (みんなの検索から)
              </h3>
              <div class="flex flex-wrap gap-3">
                <button class="px-4 py-2 text-sm font-semibold rounded-full bg-white border border-slate-300 text-slate-700 hover:bg-slate-50">コストパフォーマンスの良いOFFER</button>
                <button class="px-4 py-2 text-sm font-semibold rounded-full bg-white border border-slate-300 text-slate-700 hover:bg-slate-50">高単価・短期のREQUEST</button>
              </div>
            </div>
            <div>
              <h3 class="text-xl font-semibold text-gray-700 mb-4">タイムライン</h3>
              <div id="timeline-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            </div>
          </div>
          <div id="map-view-container" class="hidden">
            <div class="flex justify-between items-center mb-4">
               <h3 class="text-xl font-semibold text-gray-700">マーケットの地図</h3>
               <div class="inline-flex rounded-md shadow-sm bg-white p-1 text-sm">
                <button data-map-mode="jobs" class="map-mode-btn px-3 py-1 font-semibold rounded-md bg-indigo-500 text-white">取引を探す</button>
                <button data-map-mode="talent" class="map-mode-btn px-3 py-1 font-semibold rounded-md">人材を探す</button>
              </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
              <div class="relative h-96 lg:h-[60vh]">
                <canvas id="market-map-chart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-8 right-8 bg-slate-800 text-white py-3 px-5 rounded-lg shadow-lg items-center gap-4 hidden">
    <p id="toast-message" class="text-sm font-medium"></p>
  </div>
  <script>
    // --- Dummy Data ---
    const items = [
      { type: 'request', id: 1, title: 'バックエンド開発', by: 'NextGen Mart', value: 400000, nature: 0.9, reward: 400000, popularity: 8, description: 'Eコマースサイトのバックエンド開発をお願いします。Node.jsとGraphQLの経験者を募集しています。' },
      { type: 'offer', id: 2, title: '高品質なロゴを3案作成します', by: 'Sato Design', value: 50000, nature: 0.2, reward: 50000, popularity: 9, description: 'あなたのビジネスの顔となるロゴを、ヒアリングに基づき3つの異なる方向性で提案します。' },
      { type: 'request', id: 3, title: 'SNSキャンペーン企画', by: 'Growth Hackers', value: 100000, nature: 0.6, reward: 100000, popularity: 5, description: '秋のセールスプロモーションに向けたSNSキャンペーンの企画と運用をお願いします。' },
      { type: 'offer', id: 4, title: '朝採れ有機野菜セット (M)', by: 'Suzuki Farms', value: 3500, nature: 0.1, reward: 3500, popularity: 10, description: '旬の有機野菜を8〜10種類詰め合わせたセットです。新鮮な味をお楽しみください。' },
    ];
    const talents = [
      { id: 101, name: 'Sato Design', skills: ['logo', 'branding'], avgNature: 0.25, avgReward: 60000, reputation: 95 },
      { id: 102, name: 'Takahashi Dev', skills: ['backend', 'frontend'], avgNature: 0.8, avgReward: 350000, reputation: 92 },
      { id: 103, name: 'Suzuki Farms', skills: ['food', 'product'], avgNature: 0.1, avgReward: 4000, reputation: 98 },
    ];
    let cart = [];
    let results = [];
    let currentMarketView = 'timeline';
    let currentMapMode = 'jobs';
    let marketMapChart = null;
    let toastTimeout = null;

    // --- UI Elements ---
    function updateCartCount() {
      document.getElementById('cart-count').textContent = cart.length;
    }
    function showToast(message) {
      clearTimeout(toastTimeout);
      const toastEl = document.getElementById('toast');
      const toastMessageEl = document.getElementById('toast-message');
      toastMessageEl.textContent = message;
      toastEl.classList.remove('hidden');
      toastEl.classList.add('flex');
      toastTimeout = setTimeout(() => {
        toastEl.classList.add('hidden');
        toastEl.classList.remove('flex');
      }, 2000);
    }
    // --- Timeline ---
    function getCardHTML(item) {
      const isRequest = item.type === 'request';
      const valueColor = isRequest ? 'text-green-600' : 'text-orange-700';
      const sign = isRequest ? '+' : '-';
      const byLabel = isRequest ? '依頼者' : '提供者';
      const isInCart = cart.some(c => c.id === item.id);
      // ⭐️アイコンボタン
      const starBtn = `<button data-item-id="${item.id}" data-action="toggle-fav" title="お気に入り" class="star-btn ml-1 text-xl align-middle ${isInCart ? 'text-yellow-400' : 'text-slate-300 hover:text-yellow-400'}" style="background:none;border:none;outline:none;cursor:pointer;">${isInCart ? '★' : '☆'}</button>`;
      let buttonHTML = '';
      if (isRequest) {
        buttonHTML = `
          <div class="w-full mt-4 flex gap-2 items-center">
            ${starBtn}
            <button data-item-id="${item.id}" data-action="propose" class="flex-1 bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700 transition-colors text-sm">提案</button>
          </div>`;
      } else {
        buttonHTML = `
          <div class="w-full mt-4 flex gap-2 items-center">
            ${starBtn}
            <button data-item-id="${item.id}" data-action="purchase" class="flex-1 bg-orange-600 text-white font-semibold py-2 rounded-lg hover:bg-orange-700 transition-colors text-sm">購入</button>
          </div>`;
      }
      return `<div class="bg-white rounded-lg shadow-sm border p-4 flex flex-col"><div class="flex-1"><div class="flex justify-between items-start"><span class="text-xs font-semibold px-2 py-1 rounded-full ${isRequest ? 'bg-blue-100 text-blue-700' : 'bg-teal-100 text-teal-700'}">${isRequest ? 'REQUEST' : 'OFFER'}</span><span class="text-sm font-bold ${valueColor}">${sign} ¥${item.value.toLocaleString()}</span></div><h3 class="text-lg font-bold text-slate-800 mt-2">${item.title}</h3><p class="text-sm text-slate-500">${byLabel}: ${item.by}</p><p class="text-sm text-slate-600 mt-3 line-clamp-3">${item.description}</p></div>${buttonHTML}</div>`;
    }
    function renderTimeline() {
      const timelineContainer = document.getElementById('timeline-container');
      if (timelineContainer) {
        timelineContainer.innerHTML = items.map(item => getCardHTML(item)).join('');
      }
    }
    // --- Map ---
    function renderMapView() {
      const ctx = document.getElementById('market-map-chart').getContext('2d');
      if (marketMapChart) marketMapChart.destroy();
      let datasets, scales;
      if (currentMapMode === 'jobs') {
        datasets = [
          { label: 'REQUEST (+)', data: items.filter(i => i.type === 'request').map(i => ({x: i.nature, y: i.reward, r: Math.log(i.value) * 2, item: i})), backgroundColor: 'rgba(22, 163, 74, 0.6)', borderColor: 'rgba(22, 163, 74, 1)', borderWidth: 1 },
          { label: 'OFFER (-)', data: items.filter(i => i.type === 'offer').map(i => ({x: i.nature, y: i.reward, r: Math.log(i.value) * 2, item: i})), backgroundColor: 'rgba(194, 65, 12, 0.6)', borderColor: 'rgba(194, 65, 12, 1)', borderWidth: 1 }
        ];
        scales = {
          x: { title: { display: true, text: '取引の性質 (定型的 → 個別的)', font: { size: 14 } }, min: 0, max: 1 },
          y: { type: 'logarithmic', title: { display: true, text: '価格 (円)', font: { size: 14 } } }
        };
      } else {
        datasets = [{
          label: '人材 (Talent)',
          data: talents.map(t => ({x: t.avgNature, y: t.avgReward, r: t.reputation / 5, item: t})),
          backgroundColor: 'rgba(79, 70, 229, 0.6)',
          borderColor: 'rgba(79, 70, 229, 1)',
          borderWidth: 1,
        }];
        scales = {
          x: { title: { display: true, text: '得意な取引 (定型的 → 個別的)', font: { size: 14 } }, min: 0, max: 1 },
          y: { type: 'logarithmic', title: { display: true, text: '平均単価 (円)', font: { size: 14 } } }
        };
      }
      marketMapChart = new Chart(ctx, {
        type: 'bubble',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          onClick: (e) => {
            const points = marketMapChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
            if (points.length) {
              const item = marketMapChart.data.datasets[points[0].datasetIndex].data[points[0].index].item;
              addToCart(item);
            }
          },
          scales: scales,
          plugins: { tooltip: { callbacks: { label: (c) => `${c.raw.item.title || c.raw.item.name} (¥${(c.raw.item.value || c.raw.item.avgReward).toLocaleString()})` } } }
        }
      });
    }
    // --- カゴ ---
    function renderCart() {
      const list = document.getElementById('cart-list');
      list.innerHTML = '';
      if (cart.length === 0) {
        list.innerHTML = '<span class="text-slate-400">お気に入りは空です</span>';
        return;
      }
      cart.forEach(item => {
        let actions = '';
        if (item.type === 'request') {
          actions += `<button onclick="addToTask(${item.id})" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm">提案</button>`;
        }
        if (item.type === 'offer') {
          actions += `<button onclick="purchaseGoods(${item.id})" class="px-3 py-1 bg-orange-600 text-white rounded hover:bg-orange-700 text-sm">購入</button>`;
        }
        actions += `<button onclick="removeFromCart(${item.id})" class="ml-2 px-2 py-1 bg-slate-200 text-slate-600 rounded text-xs">削除</button>`;
        list.innerHTML += `
          <div class="flex items-center justify-between bg-white border rounded-lg px-4 py-2">
            <span><strong>${item.title}</strong> <span class="text-xs text-slate-500">(${item.type === 'request' ? '仕事' : '物品'})</span></span>
            <span class="actions">${actions}</span>
          </div>
        `;
      });
    }
    // --- 結果 ---
    function renderResults() {
      const list = document.getElementById('result-list');
      list.innerHTML = '';
      if (results.length === 0) {
        list.innerHTML = '<span class="text-slate-400">実行リストは空です</span>';
        return;
      }
      results.forEach(r => {
        if (r.type === 'task') {
          list.innerHTML += `<div>📝 申し込み（承認待ち）: <strong>${r.name}</strong></div>`;
        } else if (r.type === 'purchase') {
          list.innerHTML += `<div>🛒 購入: <strong>${r.name}</strong></div>`;
        }
      });
    }
    // --- カゴ操作 ---
    function addToCart(item) {
      if (!cart.some(c => c.id === item.id)) {
        cart.push(item);
        updateCartCount();
        renderCart();
        showToast(`「${item.title}」をお気に入りに追加しました。`);
      } else {
        showToast(`「${item.title}」は既にお気に入りに入っています。`);
      }
    }
    function removeFromCart(id) {
      cart = cart.filter(c => c.id !== id);
      updateCartCount();
      renderCart();
    }
    function addToTask(id) {
      const item = cart.find(i => i.id === id);
      if (item) {
        results.push({ type: 'task', name: item.title });
        removeFromCart(id);
        renderResults();
        showToast(`「${item.title}」に申し込みました（承認待ち）`);
      }
    }
    function purchaseGoods(id) {
      const item = cart.find(i => i.id === id);
      if (item) {
        results.push({ type: 'purchase', name: item.title });
        removeFromCart(id);
        renderResults();
        showToast(`「${item.title}」を購入しました。`);
      }
    }
    // --- タイムライン/マップ切替 ---
    document.addEventListener('DOMContentLoaded', () => {
      const promptInput = document.querySelector('input[type="text"]');
      if (promptInput) {
        // サジェストDOMを作成し、親要素がrelativeでなければrelativeを付与
        let promptWrap = promptInput.parentElement;
        if (promptWrap && getComputedStyle(promptWrap).position === 'static') {
          promptWrap.style.position = 'relative';
        }
        let commandSuggest = document.createElement('div');
        commandSuggest.id = 'command-suggest';
        commandSuggest.style.position = 'absolute';
        commandSuggest.style.left = '0';
        commandSuggest.style.right = '0';
        commandSuggest.style.top = '100%';
        commandSuggest.style.background = '#fff';
        commandSuggest.style.border = '1px solid #ddd';
        commandSuggest.style.zIndex = '50';
        commandSuggest.style.fontSize = '15px';
        commandSuggest.style.display = 'none';
        commandSuggest.style.boxShadow = '0 2px 8px #0002';
        commandSuggest.style.borderRadius = '0 0 8px 8px';
        commandSuggest.style.minWidth = '220px';
        commandSuggest.style.maxWidth = '100%';
        commandSuggest.style.pointerEvents = 'auto';
        const suggestItems = [
          { cmd: '/タイムライン', desc: 'タイムライン表示' },
          { cmd: '/マップ', desc: 'マップ表示' },
          { cmd: '/お気に入り', desc: 'お気に入りだけ表示' },
          { cmd: '/タスク', desc: 'タスクダッシュボード表示' },
        ];
        function renderSuggest(selectedIdx = 0) {
          commandSuggest.innerHTML = suggestItems.map((item, i) =>
            `<div class="suggest-item${i === selectedIdx ? ' bg-indigo-50 text-indigo-700' : ''}" data-idx="${i}" style="padding:8px 16px; cursor:pointer;">${item.cmd}：${item.desc}</div>`
          ).join('');
        }
        let suggestIdx = 0;
        renderSuggest(suggestIdx);
        promptWrap.appendChild(commandSuggest);
        promptInput.addEventListener('input', function(e) {
          if (promptInput.value.trim() === '/') {
            commandSuggest.style.display = 'block';
            suggestIdx = 0;
            renderSuggest(suggestIdx);
          } else {
            commandSuggest.style.display = 'none';
          }
        });
        // サジェストクリックで入力欄に反映
        commandSuggest.addEventListener('mousedown', function(e) {
          const item = e.target.closest('.suggest-item');
          if (item) {
            const idx = parseInt(item.dataset.idx);
            promptInput.value = suggestItems[idx].cmd;
            commandSuggest.style.display = 'none';
            promptInput.focus();
          }
        });
        // キーボード操作
        promptInput.addEventListener('keydown', function(e) {
          if (commandSuggest.style.display === 'block') {
            if (e.key === 'ArrowDown') {
              suggestIdx = (suggestIdx + 1) % suggestItems.length;
              renderSuggest(suggestIdx);
              e.preventDefault();
            } else if (e.key === 'ArrowUp') {
              suggestIdx = (suggestIdx - 1 + suggestItems.length) % suggestItems.length;
              renderSuggest(suggestIdx);
              e.preventDefault();
            } else if (e.key === 'Tab' || e.key === 'Enter') {
              if (promptInput.value.trim() === '/') {
                promptInput.value = suggestItems[suggestIdx].cmd;
                commandSuggest.style.display = 'none';
                promptInput.focus();
                e.preventDefault();
              }
            }
          }
        });
      }
      document.querySelectorAll('.view-toggle-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          currentMarketView = e.currentTarget.dataset.view;
          document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
          e.currentTarget.classList.add('active');
          if (currentMarketView === 'timeline') {
            document.getElementById('timeline-view-container').classList.remove('hidden');
            document.getElementById('map-view-container').classList.add('hidden');
            renderTimeline();
          } else {
            document.getElementById('timeline-view-container').classList.add('hidden');
            document.getElementById('map-view-container').classList.remove('hidden');
            renderMapView();
          }
        });
      });
      document.querySelectorAll('.map-mode-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          currentMapMode = e.currentTarget.dataset.mapMode;
          document.querySelectorAll('.map-mode-btn').forEach(b => b.classList.remove('bg-indigo-500', 'text-white'));
          e.currentTarget.classList.add('bg-indigo-500', 'text-white');
          renderMapView();
        });
      });
      document.getElementById('timeline-view-container').addEventListener('click', (e) => {
        const button = e.target.closest('[data-action]');
        if (button) {
          const itemId = parseInt(button.dataset.itemId);
          const item = items.find(i => i.id === itemId);
          if (!item) return;
          if (button.dataset.action === 'toggle-fav') {
            // お気に入り追加/解除
            if (cart.some(c => c.id === item.id)) {
              cart = cart.filter(c => c.id !== item.id);
              showToast(`「${item.title}」をお気に入りから外しました。`);
            } else {
              cart.push(item);
              showToast(`「${item.title}」をお気に入りに追加しました。`);
            }
            updateCartCount();
            renderCart();
            // タイムライン再描画でスター状態反映
            renderTimeline();
            return;
          }
          if (button.dataset.action === 'propose') {
            addToTask(item.id);
          } else if (button.dataset.action === 'purchase') {
            purchaseGoods(item.id);
          }
        }
      });
      promptInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          let valRaw = promptInput.value.trim();
          // 全角→半角変換、大文字→小文字変換（英数字のみ）
          let val = valRaw.replace(/[Ａ-Ｚａ-ｚ＠]/g, function(s) {
            return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
          }).toLowerCase();
          // /コマンドのみ判定
          if (val.startsWith('/')) {
            // 日本語コマンドはvalRawで判定
            const dashboard2Container = document.getElementById('dashboard2-iframe-container');
            if (valRaw.includes('タスク')) {
              dashboard2Container.classList.remove('hidden');
              document.getElementById('timeline-view-container').classList.add('hidden');
              document.getElementById('map-view-container').classList.add('hidden');
              showToast('タスクダッシュボードを表示しました');
            } else if (val.includes('map') || valRaw.includes('マップ')) {
              currentMarketView = 'map';
              dashboard2Container.classList.add('hidden');
              document.getElementById('timeline-view-container').classList.add('hidden');
              document.getElementById('map-view-container').classList.remove('hidden');
              renderMapView();
              showToast('マップを表示しました');
            } else if (val.includes('timeline') || valRaw.includes('タイムライン') || valRaw.includes('一覧')) {
              currentMarketView = 'timeline';
              dashboard2Container.classList.add('hidden');
              document.getElementById('timeline-view-container').classList.remove('hidden');
              document.getElementById('map-view-container').classList.add('hidden');
              renderTimeline();
              showToast('タイムラインを表示しました');
            } else if (valRaw.includes('お気に入り') || val.includes('favorite') || val.includes('fav')) {
              dashboard2Container.classList.add('hidden');
              const timelineContainer = document.getElementById('timeline-container');
              if (timelineContainer) {
                if (cart.length === 0) {
                  timelineContainer.innerHTML = '<span class="text-slate-400">お気に入りは空です</span>';
                } else {
                  timelineContainer.innerHTML = cart.map(item => getCardHTML(item)).join('');
                }
                showToast('お気に入りだけ表示');
              }
            } else {
              dashboard2Container.classList.add('hidden');
            }
            // コマンド実行後にプロンプトをクリア
            promptInput.value = '';
          }
        }
      });
      renderTimeline();
      renderCart();
      renderResults();
      updateCartCount();
    });
  </script>
</body>
</html>
